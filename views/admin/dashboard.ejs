<%- include('../partials/layout-start') %>
<%
  const donationSparkline = donations.slice(0, 8).reverse().map((item) => Number(item.amount));
  const withdrawalSparkline = withdrawals.slice(0, 8).reverse().map((item) => Number(item.amount));
  const volunteerSparkline = volunteers.slice(0, 8).reverse().map(() => 1);
  const applicantSparkline = applicants.slice(0, 8).reverse().map(() => 1);
  const activeGoal = goals.find((goal) => goal.status === 'active');
  const datasetOrder = Array.isArray(exportDatasets) ? exportDatasets : [];
  const datasetMeta = exportMeta || {};
  const getFormValue = formValue;
  const isInvalid = formInvalid;
  const fieldError = formFieldError;
  const hasFormState = (formId) => (formState && typeof formState.has === 'function' ? formState.has(formId) : false);
  const roleFilters = Object.keys((userStats && userStats.roles) || {}).sort();
  const roleSelectOptions = Array.from(new Set(['admin', 'moderator', 'donor', 'volunteer'].concat(roleFilters))).filter(Boolean);
  const statusFilters = Object.keys((userStats && userStats.statuses) || {}).sort();
  const statusOptions = Object.values(STATUSES || {});
  const humanizeAction = (action = '') => action.replace(/_/g, ' ');
  const formatDetails = (details) => {
    if (!details) return '';
    if (typeof details === 'object') {
      return Object.entries(details).map(([key, value]) => `${key}: ${value}`).join(', ');
    }
    return String(details);
  };
  const summarizePayload = (action) => {
    if (!action || !action.entity_type) return '';
    if (action.entity_type === 'donation') {
      return [
        action.payload?.donor_name,
        action.payload?.amount ? `${action.payload.amount} ${action.payload.currency || 'UAH'}` : null,
        action.payload?.message
      ]
        .filter(Boolean)
        .join(' • ');
    }
    if (action.entity_type === 'volunteer') {
      return [action.payload?.full_name, action.payload?.phone, action.payload?.region].filter(Boolean).join(' • ');
    }
    return formatDetails(action.payload);
  };
  const requestStatus = (pendingPagination && pendingPagination.status) || 'pending';
  const requestType = (pendingPagination && pendingPagination.type) || 'all';
  const requestStatusOptions = ['pending', 'approved', 'rejected', 'all'];
  const requestTypeOptions = Array.from(new Set(['all'].concat(Object.keys((pendingSummary && pendingSummary.byType) || {}))));
  const formatRequestType = (type = 'all') => {
    if (type === 'donation') return 'Донати';
    if (type === 'volunteer') return 'Волонтерство';
    if (type === 'all') return 'Усі заявки';
    return type;
  };
  const formatRequestStatus = (status = 'pending') => {
    if (status === 'approved') return 'Підтверджені';
    if (status === 'rejected') return 'Відхилені';
    if (status === 'all') return 'Усі статуси';
    return 'В очікуванні';
  };
  const statusBadgeClass = (status = 'pending') => {
    if (status === 'approved') return 'badge bg-success-subtle text-success';
    if (status === 'rejected') return 'badge bg-danger-subtle text-danger';
    return 'badge bg-warning-subtle text-warning';
  };
  const buildRequestUrl = (type = 'all', status = 'pending', page = 1) =>
    `/admin/dashboard?requestType=${encodeURIComponent(type)}&requestStatus=${encodeURIComponent(status)}&requestPage=${page}#requests`;
%>
<!-- Продовжуємо використання синьо-жовтого градієнта з першого коміту -->
<section class="page-header page-header--admin" data-reveal>
  <div class="page-header__content">
    <div>
      <p class="page-header__eyebrow">Адмін-панель</p>
      <h1>Керування фондом</h1>
      <p class="text-muted mb-0">Оновлюйте фінансові дані, модеруйтесь заявки та тримайте контент у тонусі. Зберігаємо синьо-жовті акценти першого коміту.</p>
    </div>
    <div class="admin-header-actions">
      <a class="btn btn-outline-light" href="/" target="_blank"><i class="fa-solid fa-up-right-from-square me-2"></i>Переглянути сайт</a>
      <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalExportCenter" data-export-launch>
        <i class="fa-solid fa-arrow-down-wide-short me-2"></i>Центр експорту
      </button>
      <form method="POST" action="/admin/logout">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <button class="btn btn-outline-danger" type="submit"><i class="fa-solid fa-right-from-bracket me-2"></i>Вийти</button>
      </form>
    </div>
  </div>
</section>

<section class="dashboard-kpis" data-reveal>
  <article class="dashboard-kpi-card">
    <div class="dashboard-kpi-card__header">
      <span class="dashboard-kpi-card__icon" aria-hidden="true"><i class="fa-solid fa-piggy-bank"></i></span>
      <span class="dashboard-kpi-card__label">Зібрано</span>
    </div>
    <div class="dashboard-kpi-card__value"><%= totals.totalRaised.toLocaleString('uk-UA') %> ₴</div>
    <div class="dashboard-kpi-card__meta">+<%= donations.length %> транзакцій за період</div>
    <canvas class="dashboard-kpi-card__chart" data-sparkline data-values='<%- JSON.stringify(donationSparkline) %>' data-color="primary" aria-hidden="true"></canvas>
  </article>
  <article class="dashboard-kpi-card">
    <div class="dashboard-kpi-card__header">
      <span class="dashboard-kpi-card__icon" aria-hidden="true"><i class="fa-solid fa-receipt"></i></span>
      <span class="dashboard-kpi-card__label">Використано</span>
    </div>
    <div class="dashboard-kpi-card__value text-danger"><%= totals.totalWithdrawn.toLocaleString('uk-UA') %> ₴</div>
    <div class="dashboard-kpi-card__meta">Останні витрати: <%= withdrawals[0] ? new Date(withdrawals[0].created_at).toLocaleDateString('uk-UA') : '—' %></div>
    <canvas class="dashboard-kpi-card__chart" data-sparkline data-values='<%- JSON.stringify(withdrawalSparkline) %>' data-color="danger" aria-hidden="true"></canvas>
  </article>
  <article class="dashboard-kpi-card">
    <div class="dashboard-kpi-card__header">
      <span class="dashboard-kpi-card__icon" aria-hidden="true"><i class="fa-solid fa-vault"></i></span>
      <span class="dashboard-kpi-card__label">Баланс</span>
    </div>
    <div class="dashboard-kpi-card__value text-success"><%= totals.balance.toLocaleString('uk-UA') %> ₴</div>
    <div class="dashboard-kpi-card__meta">Ціль: <%= activeGoal ? activeGoal.target_amount.toLocaleString('uk-UA') + ' ₴' : 'планується' %></div>
    <canvas class="dashboard-kpi-card__chart" data-sparkline data-values='<%- JSON.stringify(volunteerSparkline) %>' data-color="success" aria-hidden="true"></canvas>
  </article>
  <article class="dashboard-kpi-card">
    <div class="dashboard-kpi-card__header">
      <span class="dashboard-kpi-card__icon" aria-hidden="true"><i class="fa-solid fa-user-check"></i></span>
      <span class="dashboard-kpi-card__label">Очікують модерації</span>
    </div>
    <div class="dashboard-kpi-card__value"><%= applicants.length %></div>
    <div class="dashboard-kpi-card__meta">Волонтерів цього тижня: <%= volunteers.length %></div>
    <canvas class="dashboard-kpi-card__chart" data-sparkline data-values='<%- JSON.stringify(applicantSparkline) %>' data-color="warning" aria-hidden="true"></canvas>
  </article>
</section>

<div class="admin-workspace" data-reveal>
  <aside class="admin-sidebar" aria-label="Навігація панелі">
    <div class="admin-sidebar__card">
      <h2 class="admin-sidebar__title">Розділи</h2>
      <nav class="admin-nav" data-admin-nav>
        <a href="#finance" class="is-active">
          <span class="admin-nav__icon"><i class="fa-solid fa-chart-line"></i></span>
          <span class="admin-nav__label">Фінанси</span>
          <span class="admin-nav__hint">донати, витрати, реквізити</span>
        </a>
        <a href="#requests">
          <span class="admin-nav__icon"><i class="fa-solid fa-inbox"></i></span>
          <span class="admin-nav__label">Заявки</span>
          <span class="admin-nav__hint">модерація контенту</span>
        </a>
        <a href="#users">
          <span class="admin-nav__icon"><i class="fa-solid fa-users-gear"></i></span>
          <span class="admin-nav__label">Модерація</span>
          <span class="admin-nav__hint">заявки, ролі, бан</span>
        </a>
        <a href="#vehicles">
          <span class="admin-nav__icon"><i class="fa-solid fa-truck"></i></span>
          <span class="admin-nav__label">Автопарк</span>
          <span class="admin-nav__hint">статуси, інвентар</span>
        </a>
        <a href="#content">
          <span class="admin-nav__icon"><i class="fa-solid fa-newspaper"></i></span>
          <span class="admin-nav__label">Контент</span>
          <span class="admin-nav__hint">блоки, статті, медіа</span>
        </a>
        <a href="#community">
          <span class="admin-nav__icon"><i class="fa-solid fa-people-carry-box"></i></span>
          <span class="admin-nav__label">Спільнота</span>
          <span class="admin-nav__hint">відгуки, волонтери</span>
        </a>
      </nav>
    </div>
    <div class="admin-sidebar__card">
      <h2 class="admin-sidebar__title">Швидкі дії</h2>
      <div class="admin-quick-actions">
        <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalAddDonation"><i class="fa-solid fa-plus me-2"></i>Новий донат</button>
        <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalAddExpense"><i class="fa-solid fa-file-invoice-dollar me-2"></i>Витрата</button>
        <a class="btn btn-outline-light text-dark" href="#finance"><i class="fa-solid fa-vault me-2"></i>Реквізити</a>
      </div>
    </div>
    <div class="admin-sidebar__card">
      <h2 class="admin-sidebar__title">Пульс команди</h2>
      <div class="admin-sidebar__metrics">
        <div class="admin-sidebar__metric">
          <span class="admin-sidebar__metric-label">Донати (30д)</span>
          <span class="admin-sidebar__metric-value"><%= donations.length %></span>
        </div>
        <div class="admin-sidebar__metric">
          <span class="admin-sidebar__metric-label">Заявки</span>
          <span class="admin-sidebar__metric-value"><%= applicants.length %></span>
        </div>
        <div class="admin-sidebar__metric">
          <span class="admin-sidebar__metric-label">Волонтери</span>
          <span class="admin-sidebar__metric-value"><%= volunteers.length %></span>
        </div>
      </div>
    </div>
  </aside>

  <div class="admin-content">
    <section id="finance" class="admin-section" data-admin-section>
      <div class="admin-section__header">
        <div>
          <h2 class="admin-section__title">Фінансовий контроль</h2>
          <p class="admin-section__subtitle">Керуйте донатами, витратами та реквізитами. Принципи верстки з першого коміту збережено: чисті контейнери, акцентні кнопки.</p>
        </div>
        <div class="admin-section__actions">
          <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalAddDonation">Додати донат</button>
          <button class="btn btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalAddExpense">Зафіксувати витрату</button>
        </div>
      </div>
      <div class="row g-4">
        <div class="col-xl-7">
          <div class="card shadow-soft h-100">
            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
              <div>
                <h3 class="h5 mb-1">Останні донати</h3>
                <p class="small text-muted mb-0">Сторінка підтримує серверну пагінацію — у таблиці виводиться до 15 записів.</p>
              </div>
              <div class="admin-table__controls" data-table="donations">
                <label class="admin-table__search">
                  <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                  <input type="search" placeholder="Пошук по імені" data-table-search>
                </label>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-hover align-middle admin-table" data-table-body="donations">
                <thead>
                  <tr>
                    <th scope="col">Донатор</th>
                    <th scope="col">Сума</th>
                    <th scope="col">Дата</th>
                    <th scope="col">Публічний</th>
                    <th scope="col" class="text-end">Дії</th>
                  </tr>
                </thead>
                <tbody>
                  <% donations.forEach(function(donation) { %>
                    <tr>
                      <td><strong><%= donation.donor_name %></strong><br><span class="text-muted small"><%= donation.message || 'Без повідомлення' %></span></td>
                      <td><%= donation.amount.toLocaleString('uk-UA') %> <%= donation.currency %></td>
                      <td><time datetime="<%= new Date(donation.created_at).toISOString() %>"><%= new Date(donation.created_at).toLocaleString('uk-UA') %></time></td>
                      <td>
                        <% if (donation.public) { %>
                          <span class="badge bg-success-subtle text-success"><i class="fa-solid fa-eye me-1"></i>Так</span>
                        <% } else { %>
                          <span class="badge bg-warning-subtle text-warning"><i class="fa-solid fa-eye-slash me-1"></i>Ні</span>
                        <% } %>
                      </td>
                      <td class="text-end">
                        <div class="btn-group" role="group" aria-label="Керування донатом">
                          <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalEditDonation-<%= donation.id %>"><i class="fa-solid fa-pen me-1"></i>Редагувати</button>
                          <form method="POST" action="/admin/donations/<%= donation.id %>/delete" class="d-inline" onsubmit="return confirm('Видалити донат?');">
                            <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                            <button class="btn btn-sm btn-outline-danger" type="submit"><i class="fa-solid fa-trash me-1"></i>Видалити</button>
                          </form>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                  <% if (donations.length === 0) { %>
                    <tr data-table-empty>
                      <td colspan="5" class="text-center text-muted">Ще немає даних для відображення.</td>
                    </tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-xl-5">
          <div class="card shadow-soft h-100">
            <div class="card-header">
              <h3 class="h5 mb-1">Витрати</h3>
              <p class="small text-muted mb-0">Перевірені операції з підтверджуючими документами.</p>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle admin-table">
                <thead>
                  <tr>
                    <th scope="col">Призначення</th>
                    <th scope="col">Сума</th>
                    <th scope="col">Дата</th>
                  </tr>
                </thead>
                <tbody>
                  <% withdrawals.forEach(function(item) { %>
                    <tr>
                      <td><%= item.description || 'Без опису' %></td>
                      <td><%= item.amount.toLocaleString('uk-UA') %> ₴</td>
                      <td><time datetime="<%= new Date(item.created_at).toISOString() %>"><%= new Date(item.created_at).toLocaleDateString('uk-UA') %></time></td>
                    </tr>
                  <% }) %>
                  <% if (withdrawals.length === 0) { %>
                    <tr><td colspan="3" class="text-center text-muted">Витрати не зафіксовано.</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4 mt-1">
        <div class="col-lg-6">
          <div class="card shadow-soft">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h3 class="h5 mb-0">Банківські реквізити</h3>
              <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#bankAccountsCollapse" aria-expanded="true">Керувати</button>
            </div>
            <div id="bankAccountsCollapse" class="collapse show">
              <div class="card-body">
                <% bankAccounts.forEach(function(account) { %>
                  <div class="admin-form-card">
                    <div class="admin-form-card__header">
                      <h4 class="h6 mb-0"><%= account.label %></h4>
                      <span class="badge bg-light text-dark">Оновлено <%= new Date(account.updated_at).toLocaleDateString('uk-UA') %></span>
                    </div>
                    <form method="POST" action="/admin/bank-accounts/<%= account.id %>" class="admin-form row g-3" id="bank-form-<%= account.id %>" novalidate>
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <input type="hidden" name="_formId" value="bank-account:<%= account.id %>">
                      <div class="col-md-6">
                        <label class="form-label">Отримувач</label>
                        <input class="form-control<%= isInvalid(`bank-account:${account.id}`, 'recipient') ? ' is-invalid' : '' %>" type="text" name="recipient" value="<%= getFormValue(`bank-account:${account.id}`, 'recipient', account.recipient) %>" required>
                        <% if (isInvalid(`bank-account:${account.id}`, 'recipient')) { %>
                          <div class="invalid-feedback"><%= fieldError(`bank-account:${account.id}`, 'recipient') || 'Вкажіть отримувача' %></div>
                        <% } %>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">IBAN</label>
                        <input class="form-control<%= isInvalid(`bank-account:${account.id}`, 'iban') ? ' is-invalid' : '' %>" type="text" name="iban" value="<%= getFormValue(`bank-account:${account.id}`, 'iban', account.iban) %>" required>
                        <% if (isInvalid(`bank-account:${account.id}`, 'iban')) { %>
                          <div class="invalid-feedback"><%= fieldError(`bank-account:${account.id}`, 'iban') || 'Некоректний IBAN' %></div>
                        <% } %>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">ЄДРПОУ</label>
                        <input class="form-control<%= isInvalid(`bank-account:${account.id}`, 'edrpou') ? ' is-invalid' : '' %>" type="text" name="edrpou" value="<%= getFormValue(`bank-account:${account.id}`, 'edrpou', account.edrpou || '') %>">
                        <% if (isInvalid(`bank-account:${account.id}`, 'edrpou')) { %>
                          <div class="invalid-feedback"><%= fieldError(`bank-account:${account.id}`, 'edrpou') %></div>
                        <% } %>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">Призначення</label>
                        <input class="form-control<%= isInvalid(`bank-account:${account.id}`, 'purpose') ? ' is-invalid' : '' %>" type="text" name="purpose" value="<%= getFormValue(`bank-account:${account.id}`, 'purpose', account.purpose || '') %>">
                        <% if (isInvalid(`bank-account:${account.id}`, 'purpose')) { %>
                          <div class="invalid-feedback"><%= fieldError(`bank-account:${account.id}`, 'purpose') %></div>
                        <% } %>
                      </div>
                    </form>
                    <div class="admin-form-card__footer">
                      <button class="btn btn-sm btn-outline-primary" type="submit" form="bank-form-<%= account.id %>">Оновити</button>
                      <form method="POST" action="/admin/bank-accounts/<%= account.id %>/delete" class="d-inline" onsubmit="return confirm('Видалити реквізити?');">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button class="btn btn-sm btn-outline-danger" type="submit">Видалити</button>
                      </form>
                    </div>
                  </div>
                <% }) %>
                <form method="POST" action="/admin/bank-accounts" class="admin-form admin-form-card admin-form-card--inline" novalidate>
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <input type="hidden" name="_formId" value="bank-account:new">
                  <div class="admin-form-card__header">
                    <h4 class="h6 mb-0">Новий рахунок</h4>
                  </div>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Назва</label>
                      <input class="form-control<%= isInvalid('bank-account:new', 'label') ? ' is-invalid' : '' %>" type="text" name="label" value="<%= getFormValue('bank-account:new', 'label', '') %>" required>
                      <% if (isInvalid('bank-account:new', 'label')) { %>
                        <div class="invalid-feedback"><%= fieldError('bank-account:new', 'label') || 'Вкажіть назву' %></div>
                      <% } %>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Отримувач</label>
                      <input class="form-control<%= isInvalid('bank-account:new', 'recipient') ? ' is-invalid' : '' %>" type="text" name="recipient" value="<%= getFormValue('bank-account:new', 'recipient', '') %>" required>
                      <% if (isInvalid('bank-account:new', 'recipient')) { %>
                        <div class="invalid-feedback"><%= fieldError('bank-account:new', 'recipient') || 'Вкажіть отримувача' %></div>
                      <% } %>
                    </div>
                    <div class="col-12">
                      <label class="form-label">IBAN</label>
                      <input class="form-control<%= isInvalid('bank-account:new', 'iban') ? ' is-invalid' : '' %>" type="text" name="iban" value="<%= getFormValue('bank-account:new', 'iban', '') %>" required>
                      <% if (isInvalid('bank-account:new', 'iban')) { %>
                        <div class="invalid-feedback"><%= fieldError('bank-account:new', 'iban') || 'Некоректний IBAN' %></div>
                      <% } %>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">ЄДРПОУ</label>
                      <input class="form-control<%= isInvalid('bank-account:new', 'edrpou') ? ' is-invalid' : '' %>" type="text" name="edrpou" value="<%= getFormValue('bank-account:new', 'edrpou', '') %>">
                      <% if (isInvalid('bank-account:new', 'edrpou')) { %>
                        <div class="invalid-feedback"><%= fieldError('bank-account:new', 'edrpou') %></div>
                      <% } %>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Призначення</label>
                      <input class="form-control<%= isInvalid('bank-account:new', 'purpose') ? ' is-invalid' : '' %>" type="text" name="purpose" value="<%= getFormValue('bank-account:new', 'purpose', '') %>">
                      <% if (isInvalid('bank-account:new', 'purpose')) { %>
                        <div class="invalid-feedback"><%= fieldError('bank-account:new', 'purpose') %></div>
                      <% } %>
                    </div>
                  </div>
                  <div class="admin-form-card__footer">
                    <button class="btn btn-sm btn-primary" type="submit">Додати</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card shadow-soft">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h3 class="h5 mb-0">Фандрейзингові цілі</h3>
              <span class="badge bg-primary-subtle text-primary"><i class="fa-solid fa-bullseye me-1"></i><%= goals.length %> записів</span>
            </div>
            <div class="card-body">
              <% goals.forEach(function(goal) { %>
                <form method="POST" action="/admin/goals/<%= goal.id %>" class="admin-form admin-form-card" novalidate>
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <input type="hidden" name="_formId" value="goal:<%= goal.id %>">
                  <div class="admin-form-card__header">
                    <h4 class="h6 mb-0"><%= goal.title %></h4>
                    <span class="badge <%= goal.status === 'active' ? 'bg-success-subtle text-success' : 'bg-light text-dark' %>"><%= goal.status %></span>
                  </div>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Заголовок</label>
                      <input class="form-control<%= isInvalid(`goal:${goal.id}`, 'title') ? ' is-invalid' : '' %>" type="text" name="title" value="<%= getFormValue(`goal:${goal.id}`, 'title', goal.title) %>" required>
                      <% if (isInvalid(`goal:${goal.id}`, 'title')) { %>
                        <div class="invalid-feedback"><%= fieldError(`goal:${goal.id}`, 'title') || 'Вкажіть назву' %></div>
                      <% } %>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Сума</label>
                      <input class="form-control<%= isInvalid(`goal:${goal.id}`, 'target_amount') ? ' is-invalid' : '' %>" type="number" name="target_amount" min="1000" value="<%= getFormValue(`goal:${goal.id}`, 'target_amount', goal.target_amount) %>" required>
                      <% if (isInvalid(`goal:${goal.id}`, 'target_amount')) { %>
                        <div class="invalid-feedback"><%= fieldError(`goal:${goal.id}`, 'target_amount') || 'Некоректна сума' %></div>
                      <% } %>
                    </div>
                    <div class="col-12">
                      <label class="form-label">Опис</label>
                      <textarea class="form-control<%= isInvalid(`goal:${goal.id}`, 'description') ? ' is-invalid' : '' %>" name="description" rows="2"><%= getFormValue(`goal:${goal.id}`, 'description', goal.description || '') %></textarea>
                      <% if (isInvalid(`goal:${goal.id}`, 'description')) { %>
                        <div class="invalid-feedback"><%= fieldError(`goal:${goal.id}`, 'description') %></div>
                      <% } %>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Статус</label>
                      <select class="form-select<%= isInvalid(`goal:${goal.id}`, 'status') ? ' is-invalid' : '' %>" name="status" required>
                        <option value="draft" <%= getFormValue(`goal:${goal.id}`, 'status', goal.status) === 'draft' ? 'selected' : '' %>>Чернетка</option>
                        <option value="active" <%= getFormValue(`goal:${goal.id}`, 'status', goal.status) === 'active' ? 'selected' : '' %>>Активна</option>
                        <option value="archived" <%= getFormValue(`goal:${goal.id}`, 'status', goal.status) === 'archived' ? 'selected' : '' %>>Архів</option>
                      </select>
                      <% if (isInvalid(`goal:${goal.id}`, 'status')) { %>
                        <div class="invalid-feedback"><%= fieldError(`goal:${goal.id}`, 'status') || 'Оберіть статус' %></div>
                      <% } %>
                    </div>
                  </div>
                  <div class="admin-form-card__footer">
                    <button class="btn btn-sm btn-outline-primary" type="submit">Оновити</button>
                  </div>
                </form>
              <% }) %>
              <form method="POST" action="/admin/goals" class="admin-form admin-form-card" novalidate>
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="hidden" name="_formId" value="goal:new">
                <div class="admin-form-card__header">
                  <h4 class="h6 mb-0">Нова ціль</h4>
                </div>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Заголовок</label>
                    <input class="form-control<%= isInvalid('goal:new', 'title') ? ' is-invalid' : '' %>" type="text" name="title" value="<%= getFormValue('goal:new', 'title', '') %>" required>
                    <% if (isInvalid('goal:new', 'title')) { %>
                      <div class="invalid-feedback"><%= fieldError('goal:new', 'title') || 'Вкажіть назву' %></div>
                    <% } %>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Сума</label>
                    <input class="form-control<%= isInvalid('goal:new', 'target_amount') ? ' is-invalid' : '' %>" type="number" name="target_amount" min="1000" value="<%= getFormValue('goal:new', 'target_amount', '') %>" required>
                    <% if (isInvalid('goal:new', 'target_amount')) { %>
                      <div class="invalid-feedback"><%= fieldError('goal:new', 'target_amount') || 'Некоректна сума' %></div>
                    <% } %>
                  </div>
                  <div class="col-12">
                    <label class="form-label">Опис</label>
                    <textarea class="form-control<%= isInvalid('goal:new', 'description') ? ' is-invalid' : '' %>" name="description" rows="2"><%= getFormValue('goal:new', 'description', '') %></textarea>
                    <% if (isInvalid('goal:new', 'description')) { %>
                      <div class="invalid-feedback"><%= fieldError('goal:new', 'description') %></div>
                    <% } %>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Статус</label>
                    <select class="form-select<%= isInvalid('goal:new', 'status') ? ' is-invalid' : '' %>" name="status" required>
                      <option value="draft" <%= getFormValue('goal:new', 'status', 'draft') === 'draft' ? 'selected' : '' %>>Чернетка</option>
                      <option value="active" <%= getFormValue('goal:new', 'status', 'draft') === 'active' ? 'selected' : '' %>>Активна</option>
                      <option value="archived" <%= getFormValue('goal:new', 'status', 'draft') === 'archived' ? 'selected' : '' %>>Архів</option>
                    </select>
                    <% if (isInvalid('goal:new', 'status')) { %>
                      <div class="invalid-feedback"><%= fieldError('goal:new', 'status') || 'Оберіть статус' %></div>
                    <% } %>
                  </div>
                </div>
                <div class="admin-form-card__footer">
                  <button class="btn btn-sm btn-primary" type="submit">Зберегти</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="requests" class="admin-section" data-admin-section>
      <div class="admin-section__header">
        <div>
          <h2 class="admin-section__title">Центр заявок</h2>
          <p class="admin-section__subtitle">Усі донати, анкети та інші дії проходять модерацію адміністратора.</p>
        </div>
      </div>
      <div class="card shadow-soft">
      <div class="card-header d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
        <div>
          <h3 class="h5 mb-1">Черга модерації</h3>
          <p class="small text-muted mb-0">Приймайте, відхиляйте або повертайте заявки. Після підтвердження дані застосовуються до сайту.</p>
        </div>
        <span class="badge bg-warning-subtle text-warning">
          <i class="fa-solid fa-clock me-1"></i>
          В роботі: <%= (pendingSummary?.statuses?.pending || 0) %>
        </span>
      </div>
      <div class="card-body border-bottom">
        <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
          <div class="d-flex flex-wrap gap-2" role="tablist" aria-label="Фільтр за типом">
            <% requestTypeOptions.forEach(function(type) { %>
              <a class="btn btn-sm <%= requestType === type ? 'btn-primary' : 'btn-outline-primary' %>" href="<%= buildRequestUrl(type, requestStatus, 1) %>">
                <%= formatRequestType(type) %>
                <% const typeTotals = (pendingSummary?.byType && pendingSummary.byType[type]) || {}; %>
                <span class="badge bg-light text-dark ms-2"><%= typeTotals.total || 0 %></span>
              </a>
            <% }) %>
          </div>
          <div class="d-flex flex-wrap gap-2" role="tablist" aria-label="Фільтр за статусом">
            <% requestStatusOptions.forEach(function(status) { %>
              <a class="btn btn-sm <%= requestStatus === status ? 'btn-primary' : 'btn-outline-primary' %>" href="<%= buildRequestUrl(requestType, status, 1) %>">
                <%= formatRequestStatus(status) %>
                <% const count = status === 'all' ? (pendingSummary?.statuses?.total || 0) : (pendingSummary?.statuses?.[status] || 0); %>
                <span class="badge bg-light text-dark ms-2"><%= count %></span>
              </a>
            <% }) %>
          </div>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table align-middle admin-table">
          <thead>
            <tr>
              <th scope="col">Тип</th>
                <th scope="col">Дані</th>
                <th scope="col">Статус</th>
                <th scope="col" class="text-end">Дії</th>
              </tr>
            </thead>
          <tbody>
            <% pendingActions.forEach(function(action) { %>
              <tr>
                <td>
                  <span class="badge bg-light text-dark text-uppercase"><%= action.entity_type %></span>
                    <div class="small text-muted"><%= action.source || '—' %></div>
                  </td>
                  <td>
                    <strong><%= summarizePayload(action) || 'Без деталей' %></strong>
                    <% if (action.payload && action.payload.message && action.entity_type !== 'donation') { %>
                      <div class="small text-muted"><%= action.payload.message %></div>
                    <% } %>
                    <div class="small text-muted">Створено: <%= action.created_at ? new Date(action.created_at).toLocaleString('uk-UA') : '—' %></div>
                    <% if (action.processed_at) { %>
                      <div class="small text-muted">Опрацьовано: <%= new Date(action.processed_at).toLocaleString('uk-UA') %> (<%= action.processed_by_name || action.processed_by_email || '—' %>)</div>
                    <% } %>
                    <% if (action.resolution_notes) { %>
                      <div class="small text-muted"><i class="fa-solid fa-note-sticky me-1"></i><%= action.resolution_notes %></div>
                    <% } %>
                </td>
                <td>
                  <span class="<%= statusBadgeClass(action.status) %>"><%= formatRequestStatus(action.status) %></span>
                </td>
                <td class="text-end">
                  <% if (action.status === 'pending') { %>
                    <form method="POST" action="/admin/pending-actions/<%= action.id %>/approve" class="d-inline">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button class="btn btn-sm btn-success" type="submit"><i class="fa-solid fa-check me-1"></i>Прийняти</button>
                      </form>
                      <form method="POST" action="/admin/pending-actions/<%= action.id %>/reject" class="d-inline ms-1">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <input type="hidden" name="reason" value="Відхилено з адмін-панелі">
                        <button class="btn btn-sm btn-outline-danger" type="submit"><i class="fa-solid fa-xmark me-1"></i>Відхилити</button>
                      </form>
                    <% } else { %>
                      <form method="POST" action="/admin/pending-actions/<%= action.id %>/revert" class="d-inline" onsubmit="return confirm('Повернути заявку в чергу? Це видалить внесені зміни.');">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button class="btn btn-sm btn-outline-secondary" type="submit"><i class="fa-solid fa-rotate-left me-1"></i>Скасувати рішення</button>
                      </form>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            <% if (pendingActions.length === 0) { %>
                <tr><td colspan="4" class="text-center text-muted">Активних заявок за обраними фільтрами немає.</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
      <div class="card-footer d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
        <div class="text-muted small">Знайдено: <%= pendingPagination.total %> · Сторінка <%= pendingPagination.page %> з <%= pendingPagination.totalPages %></div>
        <nav aria-label="Навігація по заявках">
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item <%= pendingPagination.page <= 1 ? 'disabled' : '' %>">
              <a class="page-link" href="<%= buildRequestUrl(requestType, requestStatus, Math.max(pendingPagination.page - 1, 1)) %>">Попередня</a>
            </li>
            <% for (let i = 1; i <= pendingPagination.totalPages; i += 1) { %>
              <li class="page-item <%= pendingPagination.page === i ? 'active' : '' %>"><a class="page-link" href="<%= buildRequestUrl(requestType, requestStatus, i) %>"><%= i %></a></li>
            <% } %>
            <li class="page-item <%= pendingPagination.page >= pendingPagination.totalPages ? 'disabled' : '' %>">
              <a class="page-link" href="<%= buildRequestUrl(requestType, requestStatus, Math.min(pendingPagination.page + 1, pendingPagination.totalPages)) %>">Наступна</a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </section>

    <section id="users" class="admin-section" data-admin-section>
      <div class="admin-section__header">
        <div>
          <h2 class="admin-section__title">Модерація користувачів</h2>
          <p class="admin-section__subtitle">Підтверджуйте чеки, призначайте ролі, блокуйте порушників. Є чек-лист для кожної заявки.</p>
        </div>
      </div>
      <div class="row g-4">
        <div class="col-12">
          <div class="card shadow-soft">
            <div class="card-header d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
              <div>
                <h3 class="h5 mb-1">Нові заявки</h3>
                <p class="small text-muted mb-0">Переконайтесь, що додані чеки та контакти відповідають вимогам фонду.</p>
              </div>
              <div class="admin-table__controls" data-table="applicants">
                <label class="admin-table__search">
                  <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                  <input type="search" placeholder="Шукати заявку" data-table-search>
                </label>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table align-middle admin-table" data-table-body="applicants">
                <thead>
                  <tr>
                    <th scope="col">Користувач</th>
                    <th scope="col">Контакти</th>
                    <th scope="col">Докази</th>
                    <th scope="col">Чек-лист</th>
                    <th scope="col" class="text-end">Дії</th>
                  </tr>
                </thead>
                <tbody>
                  <% applicants.forEach(function(applicant) { %>
                    <tr>
                      <td>
                        <strong><%= applicant.full_name || '—' %></strong>
                        <div class="small text-muted"><%= applicant.created_at ? new Date(applicant.created_at).toLocaleString('uk-UA') : '' %></div>
                        <span class="badge bg-light text-dark"><%= applicant.status %></span>
                      </td>
                      <td>
                        <div class="small"><i class="fa-solid fa-envelope me-1"></i><%= applicant.email %></div>
                        <% if (applicant.phone) { %>
                          <div class="small"><i class="fa-solid fa-phone me-1"></i><%= applicant.phone %></div>
                        <% } %>
                      </td>
                      <td>
                        <% if (applicant.proof_path) { %>
                          <a class="btn btn-sm btn-outline-secondary" href="/<%= applicant.proof_path %>" target="_blank">Переглянути чек</a>
                        <% } else { %>
                          <span class="text-muted small">Не завантажено</span>
                        <% } %>
                      </td>
                      <td>
                        <ul class="moderation-checklist">
                          <li><input class="form-check-input" type="checkbox" disabled <%= applicant.proof_path ? 'checked' : '' %>> Доказ оплати</li>
                          <li><input class="form-check-input" type="checkbox" disabled <%= applicant.phone ? 'checked' : '' %>>Контакт підтверджено</li>
                          <li><input class="form-check-input" type="checkbox" disabled <%= applicant.notes ? 'checked' : '' %>>Коментар менеджера</li>
                        </ul>
                      </td>
                      <td class="text-end">
                        <form method="POST" action="/admin/users/<%= applicant.id %>/approve" class="d-inline">
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                          <input type="hidden" name="role" value="donor">
                          <button class="btn btn-sm btn-success" type="submit"><i class="fa-solid fa-check me-1"></i>Підтвердити</button>
                        </form>
                        <form method="POST" action="/admin/users/<%= applicant.id %>/reject" class="d-inline">
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                          <button class="btn btn-sm btn-outline-secondary" type="submit">Відхилити</button>
                        </form>
                        <form method="POST" action="/admin/users/<%= applicant.id %>/ban" class="d-inline" onsubmit="return confirm('Заблокувати користувача?');">
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                          <button class="btn btn-sm btn-outline-danger" type="submit">Бан</button>
                        </form>
                      </td>
                    </tr>
                  <% }) %>
                  <% if (applicants.length === 0) { %>
                    <tr data-table-empty><td colspan="5" class="text-center text-muted">Заявки відсутні.</td></tr>
                  <% } %>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-12">
          <div class="card shadow-soft">
            <div class="card-body">
              <div class="user-directory__summary">
                <span class="user-directory__summary-badge">
                  <i class="fa-solid fa-users" aria-hidden="true"></i>
                  <span data-user-total><%= allUsers.length %></span> користувачів
                </span>
                <span class="user-directory__summary-badge user-directory__summary-badge--muted">підтверджено: <%= userStats.approved %></span>
                <span class="user-directory__summary-badge user-directory__summary-badge--muted">в очікуванні: <%= userStats.pending %></span>
                <div class="user-directory__counts">
                  <% roleFilters.forEach(function(role) { %>
                    <span class="user-directory__summary-badge user-directory__summary-badge--muted"><i class="fa-solid fa-user-tag" aria-hidden="true"></i><%= role %>: <%= userStats.roles[role] %></span>
                  <% }) %>
                  <% statusFilters.filter(function(status) { return !['approved', 'pending'].includes(status); }).forEach(function(status) { %>
                    <span class="user-directory__summary-badge user-directory__summary-badge--muted"><i class="fa-solid fa-signal" aria-hidden="true"></i><%= status %>: <%= userStats.statuses[status] %></span>
                  <% }) %>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12">
          <div class="card shadow-soft">
            <div class="card-header d-flex flex-column flex-xl-row justify-content-between align-items-xl-center gap-3">
              <div>
                <h3 class="h5 mb-1">Усі користувачі</h3>
                <p class="small text-muted mb-0">Каталог усіх акаунтів фонду з можливістю змінювати статуси, ролі та залишати внутрішні примітки.</p>
              </div>
              <div class="user-directory__filters">
                <label class="admin-table__search mb-0">
                  <i class="fa-solid fa-magnifying-glass" aria-hidden="true"></i>
                  <input type="search" class="form-control" placeholder="Пошук за ім'ям або email" data-filter-search>
                </label>
                <select class="form-select" data-filter-role>
                  <option value="all">Усі ролі</option>
                  <% roleFilters.forEach(function(role) { %>
                    <option value="<%= role %>"><%= role %> (<%= userStats.roles[role] %>)</option>
                  <% }) %>
                </select>
                <select class="form-select" data-filter-status>
                  <option value="all">Усі статуси</option>
                  <% statusFilters.forEach(function(status) { %>
                    <option value="<%= status %>"><%= status %> (<%= userStats.statuses[status] %>)</option>
                  <% }) %>
                </select>
                <span class="user-directory__summary-badge user-directory__summary-badge--muted">
                  <span data-user-count><%= allUsers.length %></span> у добірці
                </span>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table align-middle admin-table mb-0" data-user-table>
                <thead>
                  <tr>
                    <th scope="col">Користувач</th>
                    <th scope="col">Контакти</th>
                    <th scope="col">Роль</th>
                    <th scope="col">Статус</th>
                    <th scope="col" class="text-end">Дії</th>
                  </tr>
                </thead>
                <tbody>
                  <% allUsers.forEach(function(user) {
                       const searchVector = [user.full_name || '', user.email || '', user.phone || '', user.role || '', user.status || ''].join(' ').toLowerCase();
                       const formIdStatus = `user-status:${user.id}`;
                       const formIdNote = `user-note:${user.id}`;
                       const roleBadgeClass = user.role === 'admin' ? 'badge-role badge-role--admin' : user.role === 'moderator' ? 'badge-role badge-role--moderator' : user.role === 'donor' ? 'badge-role badge-role--donor' : 'badge bg-light text-dark';
                       const statusClass = user.status === 'approved' ? 'badge bg-success-subtle text-success' : user.status === 'pending' ? 'badge bg-warning-subtle text-warning' : user.status === 'banned' ? 'badge bg-danger-subtle text-danger' : 'badge bg-secondary-subtle text-secondary';
                    %>
                    <tr data-user-row data-user-id="<%= user.id %>" data-role="<%= user.role %>" data-status="<%= user.status %>" data-search="<%= searchVector %>">
                      <td>
                        <strong><%= user.full_name || '—' %></strong>
                        <div class="small text-muted">ID <%= user.id %> · створено <%= user.created_at ? new Date(user.created_at).toLocaleString('uk-UA') : '—' %></div>
                      </td>
                      <td>
                        <div class="small"><i class="fa-solid fa-envelope me-1"></i><%= user.email %></div>
                        <% if (user.phone) { %><div class="small"><i class="fa-solid fa-phone me-1"></i><%= user.phone %></div><% } %>
                        <% if (user.last_login_at) { %><div class="small text-muted">Останній вхід: <%= new Date(user.last_login_at).toLocaleString('uk-UA') %></div><% } %>
                      </td>
                      <td>
                        <span class="<%= roleBadgeClass %>"><%= user.role %></span>
                        <form method="POST" action="/admin/users/<%= user.id %>/role" class="d-inline-flex align-items-center gap-2 mt-2">
                          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                          <select class="form-select form-select-sm" name="role">
                            <% roleSelectOptions.forEach(function(role) { %>
                              <option value="<%= role %>" <%= user.role === role ? 'selected' : '' %>><%= role %></option>
                            <% }) %>
                          </select>
                          <button class="btn btn-sm btn-outline-primary" type="submit">Зберегти</button>
                        </form>
                      </td>
                      <td>
                        <span class="<%= statusClass %> text-uppercase"><%= user.status %></span>
                        <% if (user.approved_at) { %>
                          <div class="small text-muted mt-1">підтверджено <%= new Date(user.approved_at).toLocaleString('uk-UA') %></div>
                        <% } %>
                      </td>
                      <td class="text-end">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-user-details-toggle aria-expanded="false">
                          <i class="fa-solid fa-clock-rotate-left me-1"></i>Історія
                        </button>
                      </td>
                    </tr>
                    <tr class="user-detail-row d-none" data-user-details="<%= user.id %>">
                      <td colspan="5">
                        <div class="user-detail">
                          <div class="user-detail__columns">
                            <div>
                              <h4 class="h6 mb-3">Журнал дій</h4>
                              <ul class="user-history-list">
                                <% (auditByUser[user.id] || []).forEach(function(entry) { %>
                                  <li class="user-history-item">
                                    <strong><%= humanizeAction(entry.action) %></strong>
                                    <% const detailText = formatDetails(entry.details); %>
                                    <% if (detailText) { %>
                                      <div class="small text-muted"><%= detailText %></div>
                                    <% } %>
                                    <% if (entry.performed_by_name) { %>
                                      <div class="small text-muted">Оператор: <%= entry.performed_by_name %> (<%= entry.performed_by_email %>)</div>
                                    <% } %>
                                    <time datetime="<%= entry.created_at %>"><%= entry.created_at ? new Date(entry.created_at).toLocaleString('uk-UA') : '—' %></time>
                                  </li>
                                <% }) %>
                                <% if ((auditByUser[user.id] || []).length === 0) { %>
                                  <li class="user-history-item text-muted">Журнал дій поки порожній.</li>
                                <% } %>
                              </ul>
                            </div>
                            <div>
                              <h4 class="h6 mb-3">Статус та примітки</h4>
                              <form method="POST" action="/admin/users/<%= user.id %>/status" class="admin-form" novalidate>
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <input type="hidden" name="_formId" value="<%= formIdStatus %>">
                                <input type="hidden" name="redirect" value="<%= getFormValue(formIdStatus, 'redirect', '/admin/dashboard#users') %>">
                                <div class="mb-3">
                                  <label class="form-label">Статус користувача</label>
                                  <select class="form-select<%= isInvalid(formIdStatus, 'status') ? ' is-invalid' : '' %>" name="status" required>
                                    <% statusOptions.forEach(function(status) { %>
                                      <option value="<%= status %>" <%= getFormValue(formIdStatus, 'status', user.status) === status ? 'selected' : '' %>><%= status %></option>
                                    <% }) %>
                                  </select>
                                  <% if (isInvalid(formIdStatus, 'status')) { %>
                                    <div class="invalid-feedback"><%= fieldError(formIdStatus, 'status') || 'Оберіть статус' %></div>
                                  <% } %>
                                </div>
                                <div class="mb-3">
                                  <label class="form-label">Коментар для команди</label>
                                  <textarea class="form-control<%= isInvalid(formIdStatus, 'notes') ? ' is-invalid' : '' %>" name="notes" rows="2"><%= getFormValue(formIdStatus, 'notes', user.notes || '') %></textarea>
                                  <% if (isInvalid(formIdStatus, 'notes')) { %>
                                    <div class="invalid-feedback"><%= fieldError(formIdStatus, 'notes') %></div>
                                  <% } %>
                                </div>
                                <button class="btn btn-sm btn-primary" type="submit">Оновити статус</button>
                              </form>
                              <hr class="my-4">
                              <form method="POST" action="/admin/users/<%= user.id %>/notes" class="admin-form" novalidate>
                                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                                <input type="hidden" name="_formId" value="<%= formIdNote %>">
                                <input type="hidden" name="redirect" value="<%= getFormValue(formIdNote, 'redirect', '/admin/dashboard#users') %>">
                                <div class="mb-3">
                                  <label class="form-label">Додати примітку</label>
                                  <textarea class="form-control<%= isInvalid(formIdNote, 'note') ? ' is-invalid' : '' %>" name="note" rows="3" required><%= getFormValue(formIdNote, 'note', '') %></textarea>
                                  <% if (isInvalid(formIdNote, 'note')) { %>
                                    <div class="invalid-feedback"><%= fieldError(formIdNote, 'note') || 'Вкажіть текст примітки' %></div>
                                  <% } %>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" type="submit">Зберегти примітку</button>
                              </form>
                              <h5 class="h6 mt-4 mb-2">Внутрішні нотатки</h5>
                              <ul class="user-notes-list">
                                <% (notesByUser[user.id] || []).forEach(function(note) { %>
                                  <li class="user-note">
                                    <div class="user-note__meta">
                                      <%= note.created_by_name || 'Система' %> · <time datetime="<%= note.created_at %>"><%= note.created_at ? new Date(note.created_at).toLocaleString('uk-UA') : '—' %></time>
                                    </div>
                                    <p class="mb-0"><%= note.note %></p>
                                  </li>
                                <% }) %>
                                <% if ((notesByUser[user.id] || []).length === 0) { %>
                                  <li class="user-note text-muted">Ще немає приміток по користувачу.</li>
                                <% } %>
                              </ul>
                            </div>
                          </div>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                  <tr data-user-empty class="<%= allUsers.length ? 'd-none' : '' %>">
                    <td colspan="5" class="text-center text-muted">Користувачів не знайдено.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>
    <section id="vehicles" class="admin-section" data-admin-section>
      <div class="admin-section__header">
        <div>
          <h2 class="admin-section__title">Автопарк</h2>
          <p class="admin-section__subtitle">Оновлюйте статуси, додавайте нові авто та керуйте інвентарем.</p>
        </div>
      </div>
      <div class="row g-4">
        <div class="col-lg-7">
          <div class="card shadow-soft">
            <div class="card-header">
              <h3 class="h5 mb-0">Поточні авто</h3>
            </div>
            <div class="list-card">
              <% vehicles.forEach(function(vehicle) { %>
                <article class="list-card-item">
                  <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
                    <div>
                      <strong><%= vehicle.name %></strong>
                      <div class="small text-muted"><%= vehicle.category || 'Без категорії' %></div>
                    </div>
                    <div class="badge bg-light text-dark align-self-start align-self-md-center"><i class="fa-solid fa-gauge-high me-1"></i><%= vehicle.status %></div>
                  </div>
                  <% if (vehicle.image_path) { %>
                    <div class="vehicle-preview">
                      <img src="/<%= vehicle.image_path %>" alt="<%= vehicle.name %>" loading="lazy">
                    </div>
                  <% } %>
                  <p class="mb-2"><%= vehicle.description %></p>
                  <form method="POST" action="/admin/vehicles/<%= vehicle.id %>" class="admin-form row g-2" id="vehicle-form-<%= vehicle.id %>" novalidate>
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <input type="hidden" name="_formId" value="vehicle:<%= vehicle.id %>">
                    <div class="col-md-6">
                      <label class="form-label">Статус</label>
                      <input class="form-control<%= isInvalid(`vehicle:${vehicle.id}`, 'status') ? ' is-invalid' : '' %>" type="text" name="status" value="<%= getFormValue(`vehicle:${vehicle.id}`, 'status', vehicle.status) %>" required>
                      <% if (isInvalid(`vehicle:${vehicle.id}`, 'status')) { %>
                        <div class="invalid-feedback"><%= fieldError(`vehicle:${vehicle.id}`, 'status') || 'Вкажіть статус' %></div>
                      <% } %>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Категорія</label>
                      <input class="form-control<%= isInvalid(`vehicle:${vehicle.id}`, 'category') ? ' is-invalid' : '' %>" type="text" name="category" value="<%= getFormValue(`vehicle:${vehicle.id}`, 'category', vehicle.category || '') %>">
                      <% if (isInvalid(`vehicle:${vehicle.id}`, 'category')) { %>
                        <div class="invalid-feedback"><%= fieldError(`vehicle:${vehicle.id}`, 'category') %></div>
                      <% } %>
                    </div>
                    <div class="col-12">
                      <label class="form-label">Опис</label>
                      <textarea class="form-control<%= isInvalid(`vehicle:${vehicle.id}`, 'description') ? ' is-invalid' : '' %>" name="description" rows="2"><%= getFormValue(`vehicle:${vehicle.id}`, 'description', vehicle.description || '') %></textarea>
                      <% if (isInvalid(`vehicle:${vehicle.id}`, 'description')) { %>
                        <div class="invalid-feedback"><%= fieldError(`vehicle:${vehicle.id}`, 'description') %></div>
                      <% } %>
                    </div>
                    <div class="col-12">
                      <label class="form-label">Зображення</label>
                      <input class="form-control<%= isInvalid(`vehicle:${vehicle.id}`, 'image_path') ? ' is-invalid' : '' %>" type="text" name="image_path" value="<%= getFormValue(`vehicle:${vehicle.id}`, 'image_path', vehicle.image_path || '') %>">
                      <% if (isInvalid(`vehicle:${vehicle.id}`, 'image_path')) { %>
                        <div class="invalid-feedback"><%= fieldError(`vehicle:${vehicle.id}`, 'image_path') %></div>
                      <% } %>
                    </div>
                  </form>
                  <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" type="submit" form="vehicle-form-<%= vehicle.id %>">Оновити</button>
                    <form method="POST" action="/admin/vehicles/<%= vehicle.id %>/delete" class="d-inline" onsubmit="return confirm('Видалити авто?');">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <button class="btn btn-sm btn-outline-danger" type="submit">Видалити</button>
                    </form>
                  </div>
                </article>
              <% }) %>
              <% if (vehicles.length === 0) { %>
                <div class="list-card-item">Список автівок поки порожній.</div>
              <% } %>
            </div>
          </div>
        </div>
        <div class="col-lg-5">
          <div class="card shadow-soft">
            <div class="card-header">
              <h3 class="h5 mb-0">Додати авто</h3>
            </div>
            <div class="card-body">
              <form method="POST" action="/admin/vehicles" class="admin-form row g-3" novalidate>
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="hidden" name="_formId" value="vehicle:new">
                <div class="col-12">
                  <label class="form-label">Назва</label>
                  <input class="form-control<%= isInvalid('vehicle:new', 'name') ? ' is-invalid' : '' %>" type="text" name="name" value="<%= getFormValue('vehicle:new', 'name', '') %>" required>
                  <% if (isInvalid('vehicle:new', 'name')) { %>
                    <div class="invalid-feedback"><%= fieldError('vehicle:new', 'name') || 'Вкажіть назву' %></div>
                  <% } %>
                </div>
                <div class="col-12">
                  <label class="form-label">Опис</label>
                  <textarea class="form-control<%= isInvalid('vehicle:new', 'description') ? ' is-invalid' : '' %>" name="description" rows="3"><%= getFormValue('vehicle:new', 'description', '') %></textarea>
                  <% if (isInvalid('vehicle:new', 'description')) { %>
                    <div class="invalid-feedback"><%= fieldError('vehicle:new', 'description') %></div>
                  <% } %>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Статус</label>
                  <input class="form-control<%= isInvalid('vehicle:new', 'status') ? ' is-invalid' : '' %>" type="text" name="status" placeholder="needs_funding" value="<%= getFormValue('vehicle:new', 'status', '') %>" required>
                  <% if (isInvalid('vehicle:new', 'status')) { %>
                    <div class="invalid-feedback"><%= fieldError('vehicle:new', 'status') || 'Вкажіть статус' %></div>
                  <% } %>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Категорія</label>
                  <input class="form-control<%= isInvalid('vehicle:new', 'category') ? ' is-invalid' : '' %>" type="text" name="category" placeholder="suv" value="<%= getFormValue('vehicle:new', 'category', '') %>">
                  <% if (isInvalid('vehicle:new', 'category')) { %>
                    <div class="invalid-feedback"><%= fieldError('vehicle:new', 'category') %></div>
                  <% } %>
                </div>
                <div class="col-12">
                  <label class="form-label">Зображення (шлях)</label>
                  <input class="form-control<%= isInvalid('vehicle:new', 'image_path') ? ' is-invalid' : '' %>" type="text" name="image_path" placeholder="images/cars/car1.jpg" value="<%= getFormValue('vehicle:new', 'image_path', '') %>">
                  <% if (isInvalid('vehicle:new', 'image_path')) { %>
                    <div class="invalid-feedback"><%= fieldError('vehicle:new', 'image_path') %></div>
                  <% } %>
                </div>
                <div class="col-12">
                  <button class="btn btn-primary" type="submit">Створити</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="content" class="admin-section" data-admin-section>
      <div class="admin-section__header">
        <div>
          <h2 class="admin-section__title">Контент та медіа</h2>
          <p class="admin-section__subtitle">Оновлюйте блоки сайту, медіа-публікації та статті. Форми мають превʼю та підказки.</p>
        </div>
      </div>
      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card shadow-soft">
            <div class="card-header">
              <h3 class="h5 mb-0">Головні блоки</h3>
            </div>
            <div class="card-body">
              <% contentBlocks.forEach(function(block) { %>
                <form method="POST" action="/admin/content-blocks/<%= block.slug %>" class="admin-form admin-form-card">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <div class="admin-form-card__header">
                    <h4 class="h6 mb-0 text-uppercase text-muted"><%= block.slug %></h4>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Заголовок</label>
                    <input class="form-control" type="text" name="title" value="<%= block.title || '' %>">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Текст</label>
                    <textarea class="form-control" name="body" rows="3"><%= block.body || '' %></textarea>
                  </div>
                  <div class="admin-form-card__footer">
                    <button class="btn btn-sm btn-outline-primary" type="submit">Оновити</button>
                  </div>
                </form>
              <% }) %>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card shadow-soft mb-4">
            <div class="card-header">
              <h3 class="h5 mb-0">Медіа про нас</h3>
            </div>
            <div class="card-body">
              <% media.forEach(function(item) { %>
                <div class="admin-form-card">
                  <div class="admin-form-card__header">
                    <h4 class="h6 mb-0"><%= item.title %></h4>
                  </div>
                  <form method="POST" action="/admin/media/<%= item.id %>" class="admin-form admin-form-card__form" id="media-form-<%= item.id %>" novalidate>
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <input type="hidden" name="_formId" value="media:<%= item.id %>">
                    <div class="mb-3">
                      <label class="form-label">Назва</label>
                      <input class="form-control<%= isInvalid(`media:${item.id}`, 'title') ? ' is-invalid' : '' %>" type="text" name="title" value="<%= getFormValue(`media:${item.id}`, 'title', item.title) %>" required>
                      <% if (isInvalid(`media:${item.id}`, 'title')) { %>
                        <div class="invalid-feedback"><%= fieldError(`media:${item.id}`, 'title') || 'Вкажіть назву' %></div>
                      <% } %>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Коротко</label>
                      <textarea class="form-control<%= isInvalid(`media:${item.id}`, 'summary') ? ' is-invalid' : '' %>" name="summary" rows="2"><%= getFormValue(`media:${item.id}`, 'summary', item.summary || '') %></textarea>
                      <% if (isInvalid(`media:${item.id}`, 'summary')) { %>
                        <div class="invalid-feedback"><%= fieldError(`media:${item.id}`, 'summary') %></div>
                      <% } %>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Посилання</label>
                      <input class="form-control<%= isInvalid(`media:${item.id}`, 'url') ? ' is-invalid' : '' %>" type="url" name="url" value="<%= getFormValue(`media:${item.id}`, 'url', item.url) %>" required>
                      <% if (isInvalid(`media:${item.id}`, 'url')) { %>
                        <div class="invalid-feedback"><%= fieldError(`media:${item.id}`, 'url') || 'Вкажіть посилання' %></div>
                      <% } %>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Зображення</label>
                      <input class="form-control<%= isInvalid(`media:${item.id}`, 'image_path') ? ' is-invalid' : '' %>" type="text" name="image_path" value="<%= getFormValue(`media:${item.id}`, 'image_path', item.image_path || '') %>">
                      <% if (isInvalid(`media:${item.id}`, 'image_path')) { %>
                        <div class="invalid-feedback"><%= fieldError(`media:${item.id}`, 'image_path') %></div>
                      <% } %>
                    </div>
                  </form>
                  <div class="admin-form-card__footer d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" type="submit" form="media-form-<%= item.id %>">Зберегти</button>
                    <form method="POST" action="/admin/media/<%= item.id %>/delete" onsubmit="return confirm('Видалити матеріал?');">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <button class="btn btn-sm btn-outline-danger" type="submit">Видалити</button>
                    </form>
                  </div>
                </div>
              <% }) %>
              <form method="POST" action="/admin/media" class="admin-form admin-form-card" novalidate>
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="hidden" name="_formId" value="media:new">
                <div class="admin-form-card__header">
                  <h4 class="h6 mb-0">Новий матеріал</h4>
                </div>
                <div class="mb-3">
                  <label class="form-label">Назва</label>
                  <input class="form-control<%= isInvalid('media:new', 'title') ? ' is-invalid' : '' %>" type="text" name="title" value="<%= getFormValue('media:new', 'title', '') %>" required>
                  <% if (isInvalid('media:new', 'title')) { %>
                    <div class="invalid-feedback"><%= fieldError('media:new', 'title') || 'Вкажіть назву' %></div>
                  <% } %>
                </div>
                <div class="mb-3">
                  <label class="form-label">Коротко</label>
                  <textarea class="form-control<%= isInvalid('media:new', 'summary') ? ' is-invalid' : '' %>" name="summary" rows="2"><%= getFormValue('media:new', 'summary', '') %></textarea>
                  <% if (isInvalid('media:new', 'summary')) { %>
                    <div class="invalid-feedback"><%= fieldError('media:new', 'summary') %></div>
                  <% } %>
                </div>
                <div class="mb-3">
                  <label class="form-label">Посилання</label>
                  <input class="form-control<%= isInvalid('media:new', 'url') ? ' is-invalid' : '' %>" type="url" name="url" value="<%= getFormValue('media:new', 'url', '') %>" required>
                  <% if (isInvalid('media:new', 'url')) { %>
                    <div class="invalid-feedback"><%= fieldError('media:new', 'url') || 'Вкажіть посилання' %></div>
                  <% } %>
                </div>
                <div class="mb-3">
                  <label class="form-label">Зображення</label>
                  <input class="form-control<%= isInvalid('media:new', 'image_path') ? ' is-invalid' : '' %>" type="text" name="image_path" value="<%= getFormValue('media:new', 'image_path', '') %>">
                  <% if (isInvalid('media:new', 'image_path')) { %>
                    <div class="invalid-feedback"><%= fieldError('media:new', 'image_path') %></div>
                  <% } %>
                </div>
                <div class="admin-form-card__footer">
                  <button class="btn btn-sm btn-primary" type="submit">Додати</button>
                </div>
              </form>
            </div>
          </div>
          <div class="card shadow-soft">
            <div class="card-header">
              <h3 class="h5 mb-0">Статті та новини</h3>
            </div>
            <div class="card-body">
              <% articles.forEach(function(article) { %>
                <div class="admin-form-card">
                  <div class="admin-form-card__header">
                    <h4 class="h6 mb-0"><%= article.title %></h4>
                    <span class="badge bg-light text-dark"><%= article.published_at ? new Date(article.published_at).toLocaleDateString('uk-UA') : 'Чернетка' %></span>
                  </div>
                  <form method="POST" action="/admin/articles/<%= article.id %>" class="admin-form admin-form-card__form" id="article-form-<%= article.id %>" novalidate>
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <input type="hidden" name="_formId" value="article:<%= article.id %>">
                    <div class="mb-3">
                      <label class="form-label">Заголовок</label>
                      <input class="form-control<%= isInvalid(`article:${article.id}`, 'title') ? ' is-invalid' : '' %>" type="text" name="title" value="<%= getFormValue(`article:${article.id}`, 'title', article.title) %>" required>
                      <% if (isInvalid(`article:${article.id}`, 'title')) { %>
                        <div class="invalid-feedback"><%= fieldError(`article:${article.id}`, 'title') || 'Вкажіть заголовок' %></div>
                      <% } %>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Анонс</label>
                      <textarea class="form-control<%= isInvalid(`article:${article.id}`, 'excerpt') ? ' is-invalid' : '' %>" name="excerpt" rows="2"><%= getFormValue(`article:${article.id}`, 'excerpt', article.excerpt || '') %></textarea>
                      <% if (isInvalid(`article:${article.id}`, 'excerpt')) { %>
                        <div class="invalid-feedback"><%= fieldError(`article:${article.id}`, 'excerpt') %></div>
                      <% } %>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Текст</label>
                      <textarea class="form-control<%= isInvalid(`article:${article.id}`, 'body') ? ' is-invalid' : '' %>" name="body" rows="3"><%= getFormValue(`article:${article.id}`, 'body', article.body || '') %></textarea>
                      <% if (isInvalid(`article:${article.id}`, 'body')) { %>
                        <div class="invalid-feedback"><%= fieldError(`article:${article.id}`, 'body') %></div>
                      <% } %>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Зображення</label>
                      <input class="form-control<%= isInvalid(`article:${article.id}`, 'cover_image') ? ' is-invalid' : '' %>" type="text" name="cover_image" value="<%= getFormValue(`article:${article.id}`, 'cover_image', article.cover_image || '') %>">
                      <% if (isInvalid(`article:${article.id}`, 'cover_image')) { %>
                        <div class="invalid-feedback"><%= fieldError(`article:${article.id}`, 'cover_image') %></div>
                      <% } %>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Дата публікації</label>
                      <input class="form-control<%= isInvalid(`article:${article.id}`, 'published_at') ? ' is-invalid' : '' %>" type="date" name="published_at" value="<%= getFormValue(`article:${article.id}`, 'published_at', article.published_at ? article.published_at.substring(0,10) : '') %>">
                      <% if (isInvalid(`article:${article.id}`, 'published_at')) { %>
                        <div class="invalid-feedback"><%= fieldError(`article:${article.id}`, 'published_at') %></div>
                      <% } %>
                    </div>
                  </form>
                  <div class="admin-form-card__footer d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" type="submit" form="article-form-<%= article.id %>">Оновити</button>
                    <form method="POST" action="/admin/articles/<%= article.id %>/delete" onsubmit="return confirm('Видалити статтю?');">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                      <button class="btn btn-sm btn-outline-danger" type="submit">Видалити</button>
                    </form>
                  </div>
                </div>
              <% }) %>
              <form method="POST" action="/admin/articles" class="admin-form admin-form-card" novalidate>
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="hidden" name="_formId" value="article:new">
                <div class="admin-form-card__header">
                  <h4 class="h6 mb-0">Нова стаття</h4>
                </div>
                <div class="mb-3">
                  <label class="form-label">Заголовок</label>
                  <input class="form-control<%= isInvalid('article:new', 'title') ? ' is-invalid' : '' %>" type="text" name="title" value="<%= getFormValue('article:new', 'title', '') %>" required>
                  <% if (isInvalid('article:new', 'title')) { %>
                    <div class="invalid-feedback"><%= fieldError('article:new', 'title') || 'Вкажіть заголовок' %></div>
                  <% } %>
                </div>
                <div class="mb-3">
                  <label class="form-label">Анонс</label>
                  <textarea class="form-control<%= isInvalid('article:new', 'excerpt') ? ' is-invalid' : '' %>" name="excerpt" rows="2"><%= getFormValue('article:new', 'excerpt', '') %></textarea>
                  <% if (isInvalid('article:new', 'excerpt')) { %>
                    <div class="invalid-feedback"><%= fieldError('article:new', 'excerpt') %></div>
                  <% } %>
                </div>
                <div class="mb-3">
                  <label class="form-label">Текст</label>
                  <textarea class="form-control<%= isInvalid('article:new', 'body') ? ' is-invalid' : '' %>" name="body" rows="3"><%= getFormValue('article:new', 'body', '') %></textarea>
                  <% if (isInvalid('article:new', 'body')) { %>
                    <div class="invalid-feedback"><%= fieldError('article:new', 'body') %></div>
                  <% } %>
                </div>
                <div class="mb-3">
                  <label class="form-label">Зображення</label>
                  <input class="form-control<%= isInvalid('article:new', 'cover_image') ? ' is-invalid' : '' %>" type="text" name="cover_image" value="<%= getFormValue('article:new', 'cover_image', '') %>">
                  <% if (isInvalid('article:new', 'cover_image')) { %>
                    <div class="invalid-feedback"><%= fieldError('article:new', 'cover_image') %></div>
                  <% } %>
                </div>
                <div class="mb-3">
                  <label class="form-label">Дата публікації</label>
                  <input class="form-control<%= isInvalid('article:new', 'published_at') ? ' is-invalid' : '' %>" type="date" name="published_at" value="<%= getFormValue('article:new', 'published_at', '') %>">
                  <% if (isInvalid('article:new', 'published_at')) { %>
                    <div class="invalid-feedback"><%= fieldError('article:new', 'published_at') %></div>
                  <% } %>
                </div>
                <div class="admin-form-card__footer">
                  <button class="btn btn-sm btn-primary" type="submit">Опублікувати</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="community" class="admin-section" data-admin-section>
      <div class="admin-section__header">
        <div>
          <h2 class="admin-section__title">Спільнота та волонтери</h2>
          <p class="admin-section__subtitle">Керуйте відгуками донаторів, запитами та останніми зверненнями.</p>
        </div>
      </div>
      <div class="row g-4">
        <div class="col-lg-6">
          <div class="card shadow-soft">
            <div class="card-header">
              <h3 class="h5 mb-0">Відгуки донаторів</h3>
            </div>
            <div class="card-body">
              <% reviews.forEach(function(review) { %>
                <form method="POST" action="/admin/reviews/<%= review.id %>/toggle" class="admin-form admin-form-card">
                  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                  <div class="admin-form-card__header d-flex justify-content-between align-items-center">
                    <h4 class="h6 mb-0"><%= review.author_name %></h4>
                    <div class="admin-switch">
                      <input type="checkbox" name="public" value="on" <%= review.public ? 'checked' : '' %> onchange="this.form.submit()" aria-label="Показувати відгук">
                    </div>
                  </div>
                  <% if (review.rating) { %>
                    <div class="review-card__rating" aria-label="Оцінка: <%= review.rating %> з 5">
                      <% for (let i = 0; i < review.rating; i++) { %>
                        <i class="fa-solid fa-star"></i>
                      <% } %>
                    </div>
                  <% } %>
                  <p class="mb-2">“<%= review.message %>”</p>
                  <p class="small text-muted mb-0"><%= new Date(review.created_at).toLocaleDateString('uk-UA') %></p>
                </form>
              <% }) %>
              <form method="POST" action="/admin/reviews" class="admin-form admin-form-card" novalidate>
                <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                <input type="hidden" name="_formId" value="review:new">
                <div class="admin-form-card__header">
                  <h4 class="h6 mb-0">Додати відгук</h4>
                </div>
                <div class="mb-3">
                  <label class="form-label">Ім'я</label>
                  <input class="form-control<%= isInvalid('review:new', 'author_name') ? ' is-invalid' : '' %>" type="text" name="author_name" value="<%= getFormValue('review:new', 'author_name', '') %>" required>
                  <% if (isInvalid('review:new', 'author_name')) { %>
                    <div class="invalid-feedback"><%= fieldError('review:new', 'author_name') || 'Вкажіть ім\'я' %></div>
                  <% } %>
                </div>
                <div class="mb-3">
                  <label class="form-label">Оцінка (1-5)</label>
                  <input class="form-control<%= isInvalid('review:new', 'rating') ? ' is-invalid' : '' %>" type="number" name="rating" min="1" max="5" value="<%= getFormValue('review:new', 'rating', '') %>">
                  <% if (isInvalid('review:new', 'rating')) { %>
                    <div class="invalid-feedback"><%= fieldError('review:new', 'rating') %></div>
                  <% } %>
                </div>
                <div class="mb-3">
                  <label class="form-label">Повідомлення</label>
                  <textarea class="form-control<%= isInvalid('review:new', 'message') ? ' is-invalid' : '' %>" name="message" rows="3" required><%= getFormValue('review:new', 'message', '') %></textarea>
                  <% if (isInvalid('review:new', 'message')) { %>
                    <div class="invalid-feedback"><%= fieldError('review:new', 'message') || 'Вкажіть текст відгуку' %></div>
                  <% } %>
                </div>
                <div class="form-check mb-3">
                  <input class="form-check-input" type="checkbox" id="review_public" name="public" value="on" <%= hasFormState('review:new') ? (getFormValue('review:new', 'public', 'off') === 'on' ? 'checked' : '') : 'checked' %>>
                  <label class="form-check-label" for="review_public">Показувати одразу</label>
                </div>
                <div class="admin-form-card__footer">
                  <button class="btn btn-sm btn-primary" type="submit">Зберегти</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="col-lg-6">
          <div class="card shadow-soft mb-4">
            <div class="card-header">
              <h3 class="h5 mb-0">Запити волонтерів</h3>
            </div>
            <div class="card-body">
              <div class="list-card">
                <% feedback.forEach(function(item) { %>
                  <div class="list-card-item">
                    <div class="d-flex justify-content-between gap-3">
                      <strong><%= item.sender_name %></strong>
                      <span class="small text-muted"><%= new Date(item.created_at).toLocaleString('uk-UA') %></span>
                    </div>
                    <p class="mb-1"><%= item.message %></p>
                    <% if (item.contact) { %>
                      <p class="small text-muted mb-1"><i class="fa-solid fa-link me-1"></i><%= item.contact %></p>
                    <% } %>
                    <% if (item.channel) { %>
                      <span class="badge bg-light text-dark"><%= item.channel %></span>
                    <% } %>
                  </div>
                <% }) %>
                <% if (feedback.length === 0) { %>
                  <div class="list-card-item">Немає нових запитів.</div>
                <% } %>
              </div>
            </div>
          </div>
          <div class="card shadow-soft">
            <div class="card-header">
              <h3 class="h5 mb-0">Нові волонтери</h3>
            </div>
            <div class="card-body">
              <div class="list-card">
                <% volunteers.forEach(function(volunteer) { %>
                  <div class="list-card-item">
                    <div class="d-flex justify-content-between gap-3">
                      <div>
                        <strong><%= volunteer.full_name %></strong>
                        <p class="mb-0 small text-muted"><%= volunteer.region || 'Регіон не вказано' %></p>
                      </div>
                      <span class="small text-muted"><%= new Date(volunteer.created_at).toLocaleString('uk-UA') %></span>
                    </div>
                    <p class="small mb-1"><i class="fa-solid fa-phone me-1"></i><%= volunteer.phone %></p>
                    <% if (volunteer.skills) { %>
                      <p class="small text-muted mb-0"><i class="fa-solid fa-toolbox me-1"></i><%= volunteer.skills %></p>
                    <% } %>
                    <div class="d-flex gap-2 mt-3">
                      <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalEditVolunteer-<%= volunteer.id %>"><i class="fa-solid fa-pen me-1"></i>Редагувати</button>
                      <form method="POST" action="/admin/volunteers/<%= volunteer.id %>/delete" class="d-inline" onsubmit="return confirm('Видалити волонтера?');">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                        <button class="btn btn-sm btn-outline-danger" type="submit"><i class="fa-solid fa-trash me-1"></i>Видалити</button>
                      </form>
                    </div>
                  </div>
                <% }) %>
                <% if (volunteers.length === 0) { %>
                  <div class="list-card-item">Поки що заявок немає.</div>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<% donations.forEach(function(donation) { const formId = `donation:${donation.id}`; %>
  <div class="modal fade" id="modalEditDonation-<%= donation.id %>" tabindex="-1" aria-labelledby="modalEditDonationLabel-<%= donation.id %>" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title fs-5" id="modalEditDonationLabel-<%= donation.id %>">Редагувати донат</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрити"></button>
        </div>
        <form method="POST" action="/admin/donations/<%= donation.id %>/update" class="admin-form" novalidate>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="_formId" value="<%= formId %>">
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Ім'я донатора</label>
                <input class="form-control<%= isInvalid(formId, 'donor_name') ? ' is-invalid' : '' %>" type="text" name="donor_name" value="<%= getFormValue(formId, 'donor_name', donation.donor_name) %>" required>
                <% if (isInvalid(formId, 'donor_name')) { %>
                  <div class="invalid-feedback"><%= fieldError(formId, 'donor_name') || 'Вкажіть імʼя' %></div>
                <% } %>
              </div>
              <div class="col-md-6">
                <label class="form-label">Сума</label>
                <div class="input-group">
                  <input class="form-control<%= isInvalid(formId, 'amount') ? ' is-invalid' : '' %>" type="number" name="amount" min="10" value="<%= getFormValue(formId, 'amount', donation.amount) %>" required>
                  <select class="form-select" name="currency">
                    <option value="UAH" <%= (getFormValue(formId, 'currency', donation.currency) === 'UAH') ? 'selected' : '' %>>UAH</option>
                    <option value="USD" <%= (getFormValue(formId, 'currency', donation.currency) === 'USD') ? 'selected' : '' %>>USD</option>
                    <option value="EUR" <%= (getFormValue(formId, 'currency', donation.currency) === 'EUR') ? 'selected' : '' %>>EUR</option>
                  </select>
                  <% if (isInvalid(formId, 'amount')) { %>
                    <div class="invalid-feedback d-block"><%= fieldError(formId, 'amount') || 'Вкажіть коректну суму' %></div>
                  <% } %>
                </div>
              </div>
              <div class="col-12">
                <label class="form-label">Повідомлення</label>
                <textarea class="form-control<%= isInvalid(formId, 'message') ? ' is-invalid' : '' %>" name="message" rows="2"><%= getFormValue(formId, 'message', donation.message || '') %></textarea>
                <% if (isInvalid(formId, 'message')) { %>
                  <div class="invalid-feedback"><%= fieldError(formId, 'message') %></div>
                <% } %>
              </div>
              <div class="col-12">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="public" id="public-<%= donation.id %>" <%= getFormValue(formId, 'public', donation.public ? 'on' : '') === 'on' ? 'checked' : '' %>>
                  <label class="form-check-label" for="public-<%= donation.id %>">Показувати на сайті</label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Скасувати</button>
            <button type="submit" class="btn btn-primary">Зберегти</button>
          </div>
        </form>
      </div>
    </div>
  </div>
<% }) %>

<% volunteers.forEach(function(volunteer) { const formId = `volunteer:${volunteer.id}`; %>
  <div class="modal fade" id="modalEditVolunteer-<%= volunteer.id %>" tabindex="-1" aria-labelledby="modalEditVolunteerLabel-<%= volunteer.id %>" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title fs-5" id="modalEditVolunteerLabel-<%= volunteer.id %>">Редагувати волонтера</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрити"></button>
        </div>
        <form method="POST" action="/admin/volunteers/<%= volunteer.id %>/update" class="admin-form" novalidate>
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="_formId" value="<%= formId %>">
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">ПІБ</label>
              <input class="form-control<%= isInvalid(formId, 'full_name') ? ' is-invalid' : '' %>" type="text" name="full_name" value="<%= getFormValue(formId, 'full_name', volunteer.full_name) %>" required>
              <% if (isInvalid(formId, 'full_name')) { %>
                <div class="invalid-feedback"><%= fieldError(formId, 'full_name') || 'Вкажіть ПІБ' %></div>
              <% } %>
            </div>
            <div class="mb-3">
              <label class="form-label">Телефон</label>
              <input class="form-control<%= isInvalid(formId, 'phone') ? ' is-invalid' : '' %>" type="tel" name="phone" value="<%= getFormValue(formId, 'phone', volunteer.phone) %>" required>
              <% if (isInvalid(formId, 'phone')) { %>
                <div class="invalid-feedback"><%= fieldError(formId, 'phone') || 'Вкажіть номер' %></div>
              <% } %>
            </div>
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input class="form-control<%= isInvalid(formId, 'email') ? ' is-invalid' : '' %>" type="email" name="email" value="<%= getFormValue(formId, 'email', volunteer.email || '') %>">
              <% if (isInvalid(formId, 'email')) { %>
                <div class="invalid-feedback"><%= fieldError(formId, 'email') %></div>
              <% } %>
            </div>
            <div class="mb-3">
              <label class="form-label">Регіон</label>
              <input class="form-control" type="text" name="region" value="<%= getFormValue(formId, 'region', volunteer.region || '') %>">
            </div>
            <div class="mb-3">
              <label class="form-label">Навички</label>
              <input class="form-control<%= isInvalid(formId, 'skills') ? ' is-invalid' : '' %>" type="text" name="skills" value="<%= getFormValue(formId, 'skills', volunteer.skills || '') %>">
              <% if (isInvalid(formId, 'skills')) { %>
                <div class="invalid-feedback"><%= fieldError(formId, 'skills') %></div>
              <% } %>
            </div>
            <div class="mb-3">
              <label class="form-label">Коментар</label>
              <textarea class="form-control<%= isInvalid(formId, 'comment') ? ' is-invalid' : '' %>" name="comment" rows="2"><%= getFormValue(formId, 'comment', volunteer.comment || '') %></textarea>
              <% if (isInvalid(formId, 'comment')) { %>
                <div class="invalid-feedback"><%= fieldError(formId, 'comment') %></div>
              <% } %>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Скасувати</button>
            <button type="submit" class="btn btn-primary">Зберегти</button>
          </div>
        </form>
      </div>
    </div>
  </div>
<% }) %>

<!-- Модалки для швидкого додавання -->
<div class="modal fade" id="modalAddDonation" tabindex="-1" aria-labelledby="modalAddDonationLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title fs-5" id="modalAddDonationLabel">Додати донат вручну</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрити"></button>
      </div>
      <form method="POST" action="/admin/donations" class="admin-form" novalidate>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <input type="hidden" name="_formId" value="donation:new">
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label" for="modal_donor_name">Ім'я</label>
              <input class="form-control<%= isInvalid('donation:new', 'donor_name') ? ' is-invalid' : '' %>" type="text" id="modal_donor_name" name="donor_name" value="<%= getFormValue('donation:new', 'donor_name', '') %>" required>
              <% if (isInvalid('donation:new', 'donor_name')) { %>
                <div class="invalid-feedback"><%= fieldError('donation:new', 'donor_name') || 'Вкажіть ім\'я' %></div>
              <% } %>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="modal_amount">Сума</label>
              <input class="form-control<%= isInvalid('donation:new', 'amount') ? ' is-invalid' : '' %>" type="number" id="modal_amount" name="amount" min="10" value="<%= getFormValue('donation:new', 'amount', '') %>" required>
              <% if (isInvalid('donation:new', 'amount')) { %>
                <div class="invalid-feedback"><%= fieldError('donation:new', 'amount') || 'Вкажіть суму' %></div>
              <% } %>
            </div>
            <div class="col-md-3">
              <label class="form-label" for="modal_currency">Валюта</label>
              <input class="form-control<%= isInvalid('donation:new', 'currency') ? ' is-invalid' : '' %>" type="text" id="modal_currency" name="currency" value="<%= getFormValue('donation:new', 'currency', 'UAH') %>">
              <% if (isInvalid('donation:new', 'currency')) { %>
                <div class="invalid-feedback"><%= fieldError('donation:new', 'currency') %></div>
              <% } %>
            </div>
            <div class="col-12">
              <label class="form-label" for="modal_message">Коментар</label>
              <textarea class="form-control<%= isInvalid('donation:new', 'message') ? ' is-invalid' : '' %>" id="modal_message" name="message" rows="3"><%= getFormValue('donation:new', 'message', '') %></textarea>
              <% if (isInvalid('donation:new', 'message')) { %>
                <div class="invalid-feedback"><%= fieldError('donation:new', 'message') %></div>
              <% } %>
            </div>
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="modal_public" name="public" value="on" <%= hasFormState('donation:new') ? (getFormValue('donation:new', 'public', 'off') === 'on' ? 'checked' : '') : 'checked' %>>
                <label class="form-check-label" for="modal_public">Показувати у публічному списку</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Скасувати</button>
          <button class="btn btn-primary" type="submit">Зберегти</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="modalAddExpense" tabindex="-1" aria-labelledby="modalAddExpenseLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title fs-5" id="modalAddExpenseLabel">Зафіксувати витрату</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрити"></button>
      </div>
      <form method="POST" action="/admin/withdrawals" class="admin-form" novalidate>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
        <input type="hidden" name="_formId" value="withdrawal:new">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label" for="modal_withdraw_amount">Сума</label>
            <input class="form-control<%= isInvalid('withdrawal:new', 'amount') ? ' is-invalid' : '' %>" type="number" id="modal_withdraw_amount" name="amount" min="1" value="<%= getFormValue('withdrawal:new', 'amount', '') %>" required>
            <% if (isInvalid('withdrawal:new', 'amount')) { %>
              <div class="invalid-feedback"><%= fieldError('withdrawal:new', 'amount') || 'Вкажіть суму' %></div>
            <% } %>
          </div>
          <div class="mb-3">
            <label class="form-label" for="modal_description">Призначення</label>
            <textarea class="form-control<%= isInvalid('withdrawal:new', 'description') ? ' is-invalid' : '' %>" id="modal_description" name="description" rows="3"><%= getFormValue('withdrawal:new', 'description', '') %></textarea>
            <% if (isInvalid('withdrawal:new', 'description')) { %>
              <div class="invalid-feedback"><%= fieldError('withdrawal:new', 'description') %></div>
            <% } %>
          </div>
          <p class="form-hint mb-0">Додайте чек у блок «Заявки» для прозорої модерації.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Скасувати</button>
          <button class="btn btn-primary" type="submit">Зафіксувати</button>
        </div>
      </form>
    </div>
  </div>
</div>
<div class="modal fade" id="modalExportCenter" tabindex="-1" aria-labelledby="modalExportCenterLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title fs-5" id="modalExportCenterLabel">Експорт даних фонду</h2>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрити"></button>
      </div>
      <form class="admin-form export-form" data-export-form data-csrf="<%= csrfToken %>" novalidate>
        <div class="modal-body">
          <p class="text-muted small mb-3">Оберіть розділи, які хочете завантажити. Ми сформуємо структурований ZIP з CSV та JSON файлами відповідно до обраних блоків.</p>
          <div class="row g-3">
            <% datasetOrder.forEach(function(key) { const meta = datasetMeta[key] || {}; %>
              <div class="col-md-6">
                <label class="export-option" for="export_<%= key %>">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="export_<%= key %>" name="datasets" value="<%= key %>" data-export-dataset checked>
                    <span class="form-check-label">
                      <span class="export-option__title"><%= meta.label || key %></span>
                      <% if (meta.description) { %>
                        <span class="export-option__description"><%= meta.description %></span>
                      <% } %>
                    </span>
                  </div>
                </label>
              </div>
            <% }) %>
          </div>
          <div class="export-status mt-3" data-export-status role="status" aria-live="polite"></div>
        </div>
        <div class="modal-footer">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 w-100">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="exportSelectAll" data-export-select-all checked>
              <label class="form-check-label small" for="exportSelectAll">Обрати/зняти всі розділи</label>
            </div>
            <div class="d-flex align-items-center gap-2 ms-auto">
              <select class="form-select form-select-sm" name="format" data-export-format>
                <option value="zip" selected>ZIP архів</option>
                <option value="json">JSON у браузері</option>
              </select>
              <button class="btn btn-outline-secondary" type="button" data-bs-dismiss="modal">Скасувати</button>
              <button class="btn btn-primary" type="submit" data-export-submit>
                <span class="me-2" aria-hidden="true"><i class="fa-solid fa-file-export"></i></span>
                Експортувати
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
<%- include('../partials/layout-end') %>
