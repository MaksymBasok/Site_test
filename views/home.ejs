<%- include('partials/layout-start') %>
<%
  const donationsList = Array.isArray(donations) ? donations : [];
  const vehiclesList = Array.isArray(vehicles) ? vehicles : [];
  const reviewsList = Array.isArray(reviews) ? reviews : [];
  const articlesList = Array.isArray(articles) ? articles : [];
  const ratedReviews = reviewsList.filter((review) => review.rating);
  const averageRatingValue = ratedReviews.length
    ? (ratedReviews.reduce((sum, review) => sum + review.rating, 0) / ratedReviews.length)
    : null;
  const averageDonation = donationsList.length
    ? Math.round(donationsList.reduce((sum, donation) => sum + donation.amount, 0) / donationsList.length)
    : null;
  const vehicleStatusLabels = {
    needs_funding: 'Збір коштів',
    in_progress: 'У процесі',
    funded: 'Передано',
    repairing: 'На ремонті',
    ready_for_mission: 'Готове до виїзду',
    scouting: 'У пошуку'
  };
  const vehicleProgress = {
    needs_funding: 0.2,
    scouting: 0.3,
    in_progress: 0.55,
    repairing: 0.7,
    ready_for_mission: 0.9,
    funded: 1
  };
%>
<!-- Зберігаємо композицію першого коміту: контрастна синьо-жовта героїчна секція -->
<section class="hero hero--spotlight" data-reveal>
  <div class="hero__inner">
    <div class="hero__content">
      <span class="hero__eyebrow">Благодійний фонд</span>
      <h1>Автомобілі для перемоги</h1>
      <p class="hero__lead">Фонд "Волонтерка" закуповує, ремонтує та доставляє транспорт для волонтерів і підрозділів ЗСУ. Ми працюємо відкрито, оперативно та поважаємо кожен донат.</p>
      <div class="hero__actions">
        <a class="btn btn-warning btn-lg" href="/donations"><i class="fa-solid fa-heart me-2"></i>Зробити внесок</a>
        <a class="btn btn-outline-light btn-lg" href="/volunteers"><i class="fa-solid fa-people-carry-box me-2"></i>Стати волонтером</a>
      </div>
      <div class="hero__assurance"><i class="fa-solid fa-shield-heart" aria-hidden="true"></i> 100% прозорі звіти та актуальні оновлення</div>
    </div>
    <div class="hero__media">
      <div class="hero__floating-card hero__floating-card--primary">
        <span class="hero__floating-label">Середній донат</span>
        <% if (averageDonation) { %>
          <strong class="hero__floating-value"><%= averageDonation.toLocaleString('uk-UA') %> ₴</strong>
          <span class="hero__floating-meta">за останні внески</span>
        <% } else { %>
          <strong class="hero__floating-value">Разом сильніші</strong>
          <span class="hero__floating-meta">Кожна гривня наближає перемогу</span>
        <% } %>
      </div>
      <div class="hero__image-frame">
        <img class="hero-illustration" src="/images/png/2.png" alt="Волонтери та автомобіль" loading="lazy">
      </div>
      <div class="hero__floating-card hero__floating-card--secondary">
        <% if (averageRatingValue) { %>
          <span class="hero__floating-label">Оцінка донаторів</span>
          <strong class="hero__floating-value"><%= averageRatingValue.toFixed(1) %><span aria-hidden="true">★</span></strong>
          <span class="hero__floating-meta">на основі <%= ratedReviews.length %> відгуків</span>
        <% } else { %>
          <span class="hero__floating-label">Авто в роботі</span>
          <strong class="hero__floating-value"><%= vehiclesList.length %></strong>
          <span class="hero__floating-meta">активних проєктів зараз</span>
        <% } %>
      </div>
    </div>
  </div>
  <div class="hero__metrics">
    <article class="hero-metric" aria-live="polite">
      <span class="hero-metric__icon" aria-hidden="true"><i class="fa-solid fa-piggy-bank"></i></span>
      <div class="hero-metric__label">Зібрано</div>
      <div class="hero-metric__value"><%= totals.totalRaised.toLocaleString('uk-UA') %> ₴</div>
    </article>
    <article class="hero-metric" aria-live="polite">
      <span class="hero-metric__icon" aria-hidden="true"><i class="fa-solid fa-bullseye"></i></span>
      <div class="hero-metric__label">Актуальна мета</div>
      <div class="hero-metric__value"><%= goal ? goal.target_amount.toLocaleString('uk-UA') + ' ₴' : 'Оголошується' %></div>
    </article>
    <article class="hero-metric" aria-live="polite">
      <span class="hero-metric__icon" aria-hidden="true"><i class="fa-solid fa-screwdriver-wrench"></i></span>
      <div class="hero-metric__label">Використано</div>
      <div class="hero-metric__value"><%= totals.totalWithdrawn.toLocaleString('uk-UA') %> ₴</div>
    </article>
    <article class="hero-metric" aria-live="polite">
      <span class="hero-metric__icon" aria-hidden="true"><i class="fa-solid fa-circle-check"></i></span>
      <div class="hero-metric__label">Залишок</div>
      <div class="hero-metric__value"><%= totals.balance.toLocaleString('uk-UA') %> ₴</div>
    </article>
  </div>
</section>

<section class="section section--surface" data-reveal>
  <div class="section__intro">
    <div>
      <h2 class="section__title">Фінансові показники</h2>
      <p class="section__description">Live-дані про збір, витрати та залишок. Цифри оновлюються автоматично на основі підтверджених операцій.</p>
    </div>
    <a href="/donations" class="section__link">Історія донатів</a>
  </div>
  <div class="kpi-grid" role="list">
    <article class="kpi-card" role="listitem">
      <div class="kpi-card__label">Собрано</div>
      <div class="kpi-card__value"><%= totals.totalRaised.toLocaleString('uk-UA') %> ₴</div>
      <div class="kpi-card__trend"><i class="fa-solid fa-arrow-trend-up"></i> +<%= donationsList.length %> донатів тиждень</div>
    </article>
    <article class="kpi-card" role="listitem">
      <div class="kpi-card__label">Ціль</div>
      <div class="kpi-card__value"><%= goal ? goal.target_amount.toLocaleString('uk-UA') + ' ₴' : 'Оголошується' %></div>
      <div class="kpi-card__trend text-muted"><i class="fa-regular fa-clock"></i> Оновлено <%= goal ? new Date(goal.updated_at).toLocaleDateString('uk-UA') : 'сьогодні' %></div>
    </article>
    <article class="kpi-card" role="listitem">
      <div class="kpi-card__label">Расходы</div>
      <div class="kpi-card__value"><%= totals.totalWithdrawn.toLocaleString('uk-UA') %> ₴</div>
      <div class="kpi-card__trend" style="color: var(--color-danger);"><i class="fa-solid fa-receipt"></i> Враховано акти та чеки</div>
    </article>
    <article class="kpi-card" role="listitem">
      <div class="kpi-card__label">Остаток</div>
      <div class="kpi-card__value"><%= totals.balance.toLocaleString('uk-UA') %> ₴</div>
      <div class="kpi-card__trend"><i class="fa-solid fa-sparkles"></i> Заплановано на техніку</div>
    </article>
  </div>
</section>

<section class="section section--goal" data-reveal>
  <div class="section__intro">
    <h2 class="section__title">Актуальна ціль</h2>
    <p class="section__description">Щодня ремонтуємо та готуємо авто до виїзду. Остання ціль — забезпечити підрозділ новим транспортом.</p>
  </div>
  <% if (goal) { %>
    <% const progress = Math.min(100, Math.round((totals.totalRaised / goal.target_amount) * 100)); %>
    <% const progressScale = Math.max(0, Math.min(1, progress / 100)); %>
    <article class="goal-card">
      <div class="goal-card__content">
        <h3><%= goal.title %></h3>
        <p><%= goal.description %></p>
        <ul class="goal-card__meta">
          <li><i class="fa-solid fa-bullseye"></i> Мета: <strong><%= goal.target_amount.toLocaleString('uk-UA') %> ₴</strong></li>
          <li><i class="fa-regular fa-clock"></i> Оновлено: <strong><%= new Date(goal.updated_at).toLocaleDateString('uk-UA') %></strong></li>
        </ul>
      </div>
      <div class="goal-card__progress">
        <div class="goal-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="<%= progress %>" data-progress style="--progress-value: <%= progressScale %>">
          <div class="goal-progress__bar"></div>
        </div>
        <div class="goal-progress__value"><%= progress %>%</div>
        <a class="btn btn-primary" href="/donations">Допомогти виконати ціль</a>
      </div>
    </article>
  <% } else { %>
    <div class="empty-state">
      <span class="empty-state__icon" aria-hidden="true"><i class="fa-solid fa-flag"></i></span>
      <div class="empty-state__content">
        <h3>Нова ціль вже готується</h3>
        <p>Стежте за оновленнями у наших соціальних мережах — скоро з'явиться свіжа задача для фонду.</p>
      </div>
    </div>
  <% } %>
</section>

<section class="section" data-reveal>
  <div class="section__intro">
    <div>
      <h2 class="section__title">Останні донати</h2>
      <p class="section__description">Ми дякуємо кожному, хто допомагає рухати волонтерський транспорт до фронту.</p>
    </div>
    <a href="/donations" class="section__link">Усі донати</a>
  </div>
  <% if (donationsList.length > 0) { %>
    <div class="donation-ticker" data-ticker data-reveal>
      <div class="donation-ticker__track" data-ticker-track>
        <% donationsList.forEach((donation) => { %>
          <article class="donation-card">
            <header class="donation-card__header">
              <span class="donation-card__avatar" aria-hidden="true"><i class="fa-solid fa-user"></i></span>
              <div class="donation-card__meta">
                <span class="donation-card__name"><%= donation.donor_name %></span>
                <time class="donation-card__date" datetime="<%= new Date(donation.created_at).toISOString() %>"><%= new Date(donation.created_at).toLocaleString('uk-UA') %></time>
              </div>
            </header>
            <div class="donation-card__amount"><%= donation.amount.toLocaleString('uk-UA') %> <%= donation.currency %></div>
            <% if (donation.message) { %>
              <p class="donation-card__message">“<%= donation.message %>”</p>
            <% } %>
          </article>
        <% }) %>
      </div>
    </div>
  <% } else { %>
    <div class="empty-state">
      <span class="empty-state__icon" aria-hidden="true"><i class="fa-solid fa-gift"></i></span>
      <div class="empty-state__content">
        <h3>Ще немає публічних донатів</h3>
        <p>Будьте першими — саме ваша підтримка відкриє рух новій партії транспорту.</p>
      </div>
    </div>
  <% } %>
</section>

<section class="section section--surface" data-reveal>
  <div class="section__intro">
    <div>
      <h2 class="section__title">Поточні автомобілі та потреби</h2>
      <p class="section__description">Ми постійно оновлюємо статус кожного авто, щоб ви знали, на якому етапі допомога.</p>
    </div>
    <a href="/cars" class="section__link">Детальніше</a>
  </div>
  <% const featuredVehicles = vehiclesList.slice(0, 3); %>
  <% if (featuredVehicles.length > 0) { %>
    <div class="card-grid card-grid--vehicles" data-skeleton>
      <% featuredVehicles.forEach((vehicle) => { %>
        <% const vehicleProgressValue = vehicleProgress[vehicle.status] || 0.35; %>
        <article class="vehicle-card is-skeleton">
          <% if (vehicle.image_path) { %>
            <div class="vehicle-card__media">
              <img src="/<%= vehicle.image_path %>" alt="<%= vehicle.name %>" loading="lazy">
              <span class="vehicle-card__badge">
                <i class="fa-solid fa-gauge-high"></i>
                <%= vehicleStatusLabels[vehicle.status] || 'У роботі' %>
              </span>
            </div>
          <% } %>
          <div class="vehicle-card__body">
            <div class="vehicle-card__header">
              <h3><%= vehicle.name %></h3>
              <span class="vehicle-card__status status-<%= vehicle.status %>"><%= vehicleStatusLabels[vehicle.status] || vehicle.status %></span>
            </div>
            <p><%= vehicle.description %></p>
            <div class="vehicle-progress" data-progress style="--progress-value: <%= vehicleProgressValue %>">
              <div class="vehicle-progress__bar"></div>
            </div>
            <div class="vehicle-card__meta">
              <span><i class="fa-solid fa-tag"></i> <%= vehicle.category || 'Спецпроєкт' %></span>
              <% const updatedAt = vehicle.updated_at || (goal ? goal.updated_at : Date.now()); %>
              <span><i class="fa-solid fa-clock-rotate-left"></i> Оновлено <%= new Date(updatedAt).toLocaleDateString('uk-UA') %></span>
            </div>
          </div>
        </article>
      <% }) %>
    </div>
  <% } else { %>
    <div class="empty-state">
      <span class="empty-state__icon" aria-hidden="true"><i class="fa-solid fa-car"></i></span>
      <div class="empty-state__content">
        <h3>Інформація оновлюється</h3>
        <p>Зараз ми готуємо новий список автівок. Загляньте трохи пізніше або зв'яжіться з координаторами напряму.</p>
      </div>
    </div>
  <% } %>
</section>

<section class="section" data-reveal>
  <div class="section__intro">
    <div>
      <h2 class="section__title">Відгуки донаторів</h2>
      <% if (reviewIntro) { %>
        <p class="section__description"><%= reviewIntro.body %></p>
      <% } else { %>
        <p class="section__description">Ми завжди тримаємо зворотний зв'язок і ділимось результатами з кожним, хто підтримує фонд.</p>
      <% } %>
    </div>
    <a href="/donations" class="section__link">Залишити відгук</a>
  </div>
  <% if (reviewsList.length > 0) { %>
    <div class="card-grid card-grid--reviews">
      <% reviewsList.forEach((review) => { %>
        <article class="review-card">
          <header class="review-card__header">
            <span class="review-card__avatar" aria-hidden="true"><i class="fa-solid fa-user-circle"></i></span>
            <div>
              <span class="review-card__name"><%= review.author_name %></span>
              <span class="review-card__date"><%= new Date(review.created_at).toLocaleDateString('uk-UA') %></span>
            </div>
          </header>
          <% if (review.rating) { %>
            <div class="review-card__rating" aria-label="Оцінка: <%= review.rating %> з 5">
              <% for (let i = 0; i < review.rating; i++) { %>
                <i class="fa-solid fa-star"></i>
              <% } %>
            </div>
          <% } %>
          <p class="review-card__message">“<%= review.message %>”</p>
        </article>
      <% }) %>
    </div>
  <% } else { %>
    <div class="empty-state">
      <span class="empty-state__icon" aria-hidden="true"><i class="fa-solid fa-comments"></i></span>
      <div class="empty-state__content">
        <h3>Очікуємо перші відгуки</h3>
        <p>Щойно розпочали кампанію — скоро тут з'являться відгуки людей, які вже допомогли.</p>
      </div>
    </div>
  <% } %>
</section>

<section class="section" data-reveal>
  <div class="section__intro">
    <div>
      <h2 class="section__title">Свіжі новини</h2>
      <p class="section__description">Звіти про передані авто, історії з фронту та корисні поради для волонтерів.</p>
    </div>
    <a href="/articles" class="section__link">Усі матеріали</a>
  </div>
  <% if (articlesList.length > 0) { %>
    <div class="card-grid card-grid--articles">
      <% articlesList.forEach((article) => { %>
        <article class="article-card">
          <% if (article.cover_image) { %>
            <div class="article-card__media">
              <img src="/<%= article.cover_image %>" alt="<%= article.title %>" loading="lazy">
            </div>
          <% } %>
          <div class="article-card__body">
            <h3><a href="/articles/<%= article.id %>"><%= article.title %></a></h3>
            <% if (article.excerpt) { %>
              <p><%= article.excerpt %></p>
            <% } %>
            <div class="article-card__meta">
              <span><i class="fa-regular fa-calendar"></i> <%= article.published_at ? new Date(article.published_at).toLocaleDateString('uk-UA') : 'Незабаром' %></span>
            </div>
          </div>
        </article>
      <% }) %>
    </div>
  <% } else { %>
    <div class="empty-state">
      <span class="empty-state__icon" aria-hidden="true"><i class="fa-solid fa-newspaper"></i></span>
      <div class="empty-state__content">
        <h3>Матеріали готуються</h3>
        <p>Команда працює над новими публікаціями. Поверніться трохи згодом, щоб нічого не пропустити.</p>
      </div>
    </div>
  <% } %>
</section>

<section class="section section--cta" data-reveal>
  <div class="cta-banner">
    <div class="cta-banner__content">
      <h2>Ваш донат — це врятовані життя</h2>
      <p>Навіть 200 гривень допомагають викупити запчастини, заправити авто та евакуювати людей із небезпеки.</p>
      <div class="cta-banner__actions">
        <a class="btn btn-light btn-lg" href="/donations"><i class="fa-solid fa-heart-circle-bolt me-2"></i>Підтримати фонд</a>
        <a class="btn btn-outline-light btn-lg" href="/documents"><i class="fa-solid fa-file-shield me-2"></i>Переглянути звіти</a>
      </div>
    </div>
  </div>
</section>
<%- include('partials/layout-end') %>
